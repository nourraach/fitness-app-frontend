<!-- Navbar conditionnelle -->
<app-coach-navbar *ngIf="userRole === 'coach'"></app-coach-navbar>
<app-navbar *ngIf="userRole !== 'coach'"></app-navbar>

<div class="programmes-container">
  <div class="header">
    <h1>{{ userRole === 'coach' ? 'Mes Programmes d\'Entraînement' : 'Mes Programmes' }}</h1>
    <button *ngIf="userRole === 'coach'" class="btn-primary" (click)="afficherFormulaire()">
      <i class="fas fa-plus"></i> Créer un Programme
    </button>
  </div>

  <!-- Messages -->
  <div *ngIf="success" class="alert alert-success">{{ success }}</div>
  <div *ngIf="error" class="alert alert-error">{{ error }}</div>

  <!-- Formulaire de création/modification -->
  <div *ngIf="showForm" class="form-modal">
    <div class="form-container">
      <div class="form-header">
        <h2>{{ isEditing ? 'Modifier le Programme' : 'Créer un Programme' }}</h2>
        <button class="btn-close" (click)="annulerFormulaire()">×</button>
      </div>

      <form (ngSubmit)="soumettreProgramme()">
        <div class="form-group">
          <label>Client *</label>
          <select [(ngModel)]="programme.clientId" name="clientId" required [disabled]="isEditing">
            <option value="0">Sélectionner un client</option>
            <option *ngFor="let client of clients" [value]="client.id">{{ client.name }}</option>
          </select>
        </div>

        <div class="form-group">
          <label>Nom du Programme *</label>
          <input type="text" [(ngModel)]="programme.nom" name="nom" required placeholder="Ex: Programme Prise de Masse">
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea [(ngModel)]="programme.description" name="description" rows="3" 
                    placeholder="Décrivez les objectifs du programme..."></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Date de Début *</label>
            <input type="date" [(ngModel)]="programme.dateDebut" name="dateDebut" required>
          </div>
          <div class="form-group">
            <label>Date de Fin *</label>
            <input type="date" [(ngModel)]="programme.dateFin" name="dateFin" required>
          </div>
        </div>

        <!-- Section Exercices -->
        <div class="exercices-section">
          <h3>Exercices</h3>
          
          <div class="exercice-form">
            <div class="form-row">
              <div class="form-group">
                <input type="text" [(ngModel)]="nouvelExercice.nom" name="exerciceNom" 
                       placeholder="Nom de l'exercice">
              </div>
              <div class="form-group">
                <input type="text" [(ngModel)]="nouvelExercice.description" name="exerciceDesc" 
                       placeholder="Description">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <input type="number" [(ngModel)]="nouvelExercice.series" name="series" 
                       placeholder="Séries" min="0">
              </div>
              <div class="form-group">
                <input type="number" [(ngModel)]="nouvelExercice.repetitions" name="repetitions" 
                       placeholder="Répétitions" min="0">
              </div>
              <div class="form-group">
                <input type="number" [(ngModel)]="nouvelExercice.dureeMinutes" name="duree" 
                       placeholder="Durée (min)" min="0">
              </div>
              <div class="form-group">
                <select [(ngModel)]="nouvelExercice.intensite" name="intensite">
                  <option value="FAIBLE">Faible</option>
                  <option value="MOYENNE">Moyenne</option>
                  <option value="ELEVEE">Élevée</option>
                  <option value="MAXIMALE">Maximale</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <input type="text" [(ngModel)]="nouvelExercice.notes" name="notes" 
                     placeholder="Notes supplémentaires">
            </div>

            <button type="button" class="btn-secondary" (click)="ajouterExercice()">
              <i class="fas fa-plus"></i> Ajouter l'Exercice
            </button>
          </div>

          <!-- Liste des exercices ajoutés -->
          <div *ngIf="programme.exercices.length > 0" class="exercices-liste">
            <h4>Exercices ajoutés ({{ programme.exercices.length }})</h4>
            <div *ngFor="let exercice of programme.exercices; let i = index" class="exercice-item">
              <div class="exercice-info">
                <strong>{{ exercice.nom }}</strong>
                <span *ngIf="exercice.description"> - {{ exercice.description }}</span>
                <div class="exercice-details">
                  <span *ngIf="exercice.series">{{ exercice.series }} séries</span>
                  <span *ngIf="exercice.repetitions">{{ exercice.repetitions }} rép.</span>
                  <span *ngIf="exercice.dureeMinutes">{{ exercice.dureeMinutes }} min</span>
                  <span class="intensite">{{ exercice.intensite }}</span>
                </div>
                <small *ngIf="exercice.notes">{{ exercice.notes }}</small>
              </div>
              <button type="button" class="btn-delete" (click)="retirerExercice(i)">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="annulerFormulaire()">Annuler</button>
          <button type="submit" class="btn-primary" [disabled]="loading">
            {{ loading ? 'Enregistrement...' : (isEditing ? 'Modifier' : 'Créer') }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Liste des programmes -->
  <div *ngIf="loading && !showForm" class="loading">Chargement...</div>

  <div *ngIf="!loading && programmes.length === 0" class="empty-state">
    <i class="fas fa-dumbbell"></i>
    <p>{{ userRole === 'coach' ? 'Aucun programme créé' : 'Aucun programme assigné' }}</p>
  </div>

  <div class="programmes-grid">
    <div *ngFor="let prog of programmes" class="programme-card">
      <div class="card-header">
        <h3>{{ prog.nom }}</h3>
        <span class="statut-badge" [ngClass]="getStatutClass(prog.statut)">{{ prog.statut }}</span>
      </div>

      <div class="card-body">
        <p *ngIf="prog.description" class="description">{{ prog.description }}</p>
        
        <div class="info-row">
          <span><i class="fas fa-user"></i> 
            {{ userRole === 'coach' ? 'Client: ' + prog.nomClient : 'Coach: ' + prog.nomCoach }}
          </span>
        </div>

        <div class="info-row">
          <span><i class="fas fa-calendar"></i> {{ prog.dateDebut | date:'dd/MM/yyyy' }} - {{ prog.dateFin | date:'dd/MM/yyyy' }}</span>
        </div>

        <div class="info-row">
          <span><i class="fas fa-dumbbell"></i> {{ prog.exercices.length || 0 }} exercice(s)</span>
        </div>

        <!-- Détails des exercices -->
        <div *ngIf="prog.exercices && prog.exercices.length > 0" class="exercices-preview">
          <h4>Exercices:</h4>
          <ul>
            <li *ngFor="let ex of prog.exercices">
              <strong>{{ ex.nom }}</strong>
              <span *ngIf="ex.series || ex.repetitions || ex.dureeMinutes">
                - 
                <span *ngIf="ex.series">{{ ex.series }}×{{ ex.repetitions }}</span>
                <span *ngIf="ex.dureeMinutes">{{ ex.dureeMinutes }}min</span>
              </span>
            </li>
          </ul>
        </div>
      </div>

      <div *ngIf="userRole === 'coach'" class="card-actions">
        <button class="btn-icon" (click)="modifierProgramme(prog)" title="Modifier">
          <i class="fas fa-edit"></i>
        </button>
        
        <div class="statut-actions">
          <button *ngIf="prog.statut === 'ACTIF'" class="btn-icon" (click)="changerStatut(prog.id!, 'TERMINE')" title="Terminer">
            <i class="fas fa-check"></i>
          </button>
          <button *ngIf="prog.statut === 'ACTIF'" class="btn-icon" (click)="changerStatut(prog.id!, 'SUSPENDU')" title="Suspendre">
            <i class="fas fa-pause"></i>
          </button>
          <button *ngIf="prog.statut === 'SUSPENDU'" class="btn-icon" (click)="changerStatut(prog.id!, 'ACTIF')" title="Réactiver">
            <i class="fas fa-play"></i>
          </button>
        </div>

        <button class="btn-icon btn-danger" (click)="supprimerProgramme(prog.id!)" title="Supprimer">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  </div>
</div>
