<!-- Navbar -->
<app-coach-navbar></app-coach-navbar>

<div class="programmes-container">
  <!-- Header -->
  <div class="header">
    <h1>{{ userRole === 'coach' ? 'üèãÔ∏è Mes Programmes d\'Entra√Ænement' : 'üìã Mes Programmes' }}</h1>
    <button *ngIf="userRole === 'coach'" class="btn-primary" (click)="afficherFormulaire()">
      <i class="pi pi-plus"></i> Cr√©er un Programme
    </button>
  </div>

  <!-- Messages -->
  <div *ngIf="success" class="alert alert-success">
    <i class="pi pi-check-circle"></i> {{ success }}
  </div>
  <div *ngIf="error" class="alert alert-error">
    <i class="pi pi-exclamation-triangle"></i> {{ error }}
  </div>

  <!-- Modal Formulaire -->
  <div *ngIf="showForm" class="form-modal">
    <div class="form-container">
      <div class="form-header">
        <h2>{{ isEditing ? '‚úèÔ∏è Modifier le Programme' : '‚ûï Cr√©er un Programme' }}</h2>
        <button class="btn-close" (click)="annulerFormulaire()">√ó</button>
      </div>

      <form (ngSubmit)="soumettreProgramme()">
        <!-- S√©lection Client -->
        <div class="form-group">
          <label>üë§ Client *</label>
          <select [(ngModel)]="formData.clientId" name="clientId" required [disabled]="isEditing">
            <option [value]="0">-- S√©lectionner un client --</option>
            <option *ngFor="let client of clients" [value]="client.id">
              {{ client.name }} ({{ client.email }})
            </option>
          </select>
          <small class="hint">Le client doit √™tre assign√© √† votre liste</small>
        </div>

        <!-- Nom du Programme -->
        <div class="form-group">
          <label>üìù Nom du Programme *</label>
          <input 
            type="text" 
            [(ngModel)]="formData.nom" 
            name="nom" 
            required 
            placeholder="Ex: Programme Perte de Poids"
            maxlength="100">
        </div>

        <!-- Description -->
        <div class="form-group">
          <label>üìÑ Description</label>
          <textarea 
            [(ngModel)]="formData.description" 
            name="description" 
            rows="3" 
            placeholder="D√©crivez les objectifs du programme..."
            maxlength="500"></textarea>
        </div>

        <!-- Dates -->
        <div class="form-row">
          <div class="form-group">
            <label>üìÖ Date de D√©but *</label>
            <input type="date" [(ngModel)]="formData.dateDebut" name="dateDebut" required>
          </div>
          <div class="form-group">
            <label>üìÖ Date de Fin *</label>
            <input type="date" [(ngModel)]="formData.dateFin" name="dateFin" required>
          </div>
        </div>

        <!-- Section Exercices -->
        <div class="exercices-section">
          <h3>üí™ Exercices</h3>
          
          <!-- Formulaire d'ajout d'exercice -->
          <div class="exercice-form">
            <div class="form-group">
              <label>Nom de l'exercice</label>
              <input 
                type="text" 
                [(ngModel)]="nouvelExercice.nom" 
                name="exerciceNom" 
                placeholder="Ex: Squats">
            </div>

            <div class="form-row form-row-4">
              <div class="form-group">
                <label>S√©ries</label>
                <input 
                  type="number" 
                  [(ngModel)]="nouvelExercice.series" 
                  name="series" 
                  min="1"
                  (input)="forcePositive('series')"
                  placeholder="4">
              </div>
              <div class="form-group">
                <label>R√©p√©titions</label>
                <input 
                  type="number" 
                  [(ngModel)]="nouvelExercice.repetitions" 
                  name="repetitions" 
                  min="1"
                  (input)="forcePositive('repetitions')"
                  placeholder="12">
              </div>
              <div class="form-group">
                <label>Repos (sec)</label>
                <input 
                  type="number" 
                  [(ngModel)]="nouvelExercice.tempsRepos" 
                  name="tempsRepos" 
                  min="0"
                  (input)="forceNonNegative('tempsRepos')"
                  placeholder="60">
              </div>
              <div class="form-group">
                <label>Poids (kg)</label>
                <input 
                  type="number" 
                  [(ngModel)]="nouvelExercice.poids" 
                  name="poids" 
                  min="0" 
                  step="0.5"
                  (input)="forceNonNegative('poids')"
                  placeholder="20">
              </div>
            </div>

            <button type="button" class="btn-secondary" (click)="ajouterExercice()">
              <i class="pi pi-plus"></i> Ajouter l'Exercice
            </button>
          </div>

          <!-- Liste des exercices ajout√©s -->
          <div *ngIf="formData.exercices.length > 0" class="exercices-liste">
            <h4>Exercices ajout√©s ({{ formData.exercices.length }})</h4>
            <div *ngFor="let exercice of formData.exercices; let i = index" class="exercice-item">
              <div class="exercice-info">
                <strong>{{ exercice.nom }}</strong>
                <div class="exercice-details">
                  <span class="badge">{{ exercice.series }} s√©ries</span>
                  <span class="badge">{{ exercice.repetitions }} r√©p.</span>
                  <span class="badge">{{ exercice.tempsRepos }}s repos</span>
                  <span class="badge" *ngIf="exercice.poids > 0">{{ exercice.poids }} kg</span>
                </div>
              </div>
              <button type="button" class="btn-delete" (click)="retirerExercice(i)" title="Supprimer">
                <i class="pi pi-trash"></i>
              </button>
            </div>
          </div>

          <div *ngIf="formData.exercices.length === 0" class="empty-exercices">
            <i class="pi pi-info-circle"></i>
            <span>Ajoutez au moins un exercice au programme</span>
          </div>
        </div>

        <!-- Actions -->
        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="annulerFormulaire()">
            Annuler
          </button>
          <button type="submit" class="btn-primary" [disabled]="loading">
            <span *ngIf="loading"><i class="pi pi-spin pi-spinner"></i> Enregistrement...</span>
            <span *ngIf="!loading">{{ isEditing ? 'Modifier' : 'Cr√©er le Programme' }}</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading && !showForm" class="loading">
    <i class="pi pi-spin pi-spinner"></i> Chargement des programmes...
  </div>

  <!-- √âtat vide -->
  <div *ngIf="!loading && programmes.length === 0" class="empty-state">
    <i class="pi pi-calendar"></i>
    <h3>{{ userRole === 'coach' ? 'Aucun programme cr√©√©' : 'Aucun programme assign√©' }}</h3>
    <p *ngIf="userRole === 'coach'">Cr√©ez votre premier programme d'entra√Ænement</p>
    <button *ngIf="userRole === 'coach'" class="btn-primary" (click)="afficherFormulaire()">
      <i class="pi pi-plus"></i> Cr√©er un Programme
    </button>
  </div>

  <!-- Liste des programmes -->
  <div class="programmes-grid" *ngIf="programmes.length > 0">
    <div *ngFor="let prog of programmes" class="programme-card">
      <div class="card-header">
        <h3>{{ prog.nom }}</h3>
        <span class="statut-badge" [ngClass]="getStatutClass(prog.statut)">
          {{ getStatutLabel(prog.statut) }}
        </span>
      </div>

      <div class="card-body">
        <p *ngIf="prog.description" class="description">{{ prog.description }}</p>
        
        <div class="info-row">
          <i class="pi pi-user"></i>
          <span>{{ userRole === 'coach' ? 'Client: ' + (prog.nomClient || 'N/A') : 'Coach: ' + (prog.nomCoach || 'N/A') }}</span>
        </div>

        <div class="info-row">
          <i class="pi pi-calendar"></i>
          <span>{{ prog.dateDebut | date:'dd/MM/yyyy' }} ‚Üí {{ prog.dateFin | date:'dd/MM/yyyy' }}</span>
        </div>

        <div class="info-row">
          <i class="pi pi-list"></i>
          <span>{{ prog.exercices ? prog.exercices.length : 0 }} exercice(s)</span>
        </div>

        <!-- Aper√ßu des exercices -->
        <div *ngIf="prog.exercices && prog.exercices.length > 0" class="exercices-preview">
          <h4>Exercices:</h4>
          <ul>
            <li *ngFor="let ex of prog.exercices.slice(0, 3)">
              <strong>{{ ex.nom }}</strong>
              <span class="ex-details">
                {{ ex.series }}√ó{{ ex.repetitions }}
                <span *ngIf="ex.poids > 0"> - {{ ex.poids }}kg</span>
              </span>
            </li>
            <li *ngIf="prog.exercices.length > 3" class="more">
              +{{ prog.exercices.length - 3 }} autres...
            </li>
          </ul>
        </div>
      </div>

      <!-- Actions Coach -->
      <div *ngIf="userRole === 'coach'" class="card-actions">
        <button class="btn-icon" (click)="modifierProgramme(prog)" title="Modifier">
          <i class="pi pi-pencil"></i>
        </button>
        
        <div class="statut-actions">
          <button 
            *ngIf="isStatutActif(prog.statut)" 
            class="btn-icon btn-success" 
            (click)="changerStatut(prog.id, 'COMPLETED')" 
            title="Marquer comme termin√©">
            <i class="pi pi-check"></i>
          </button>
          <button 
            *ngIf="isStatutActif(prog.statut)" 
            class="btn-icon btn-warning" 
            (click)="changerStatut(prog.id, 'PAUSED')" 
            title="Mettre en pause">
            <i class="pi pi-pause"></i>
          </button>
          <button 
            *ngIf="isStatutPause(prog.statut)" 
            class="btn-icon btn-info" 
            (click)="changerStatut(prog.id, 'ACTIVE')" 
            title="R√©activer">
            <i class="pi pi-play"></i>
          </button>
        </div>

        <button class="btn-icon btn-danger" (click)="supprimerProgramme(prog.id)" title="Supprimer">
          <i class="pi pi-trash"></i>
        </button>
      </div>

      <!-- Actions Client -->
      <div *ngIf="userRole !== 'coach'" class="card-actions client-actions">
        <button 
          *ngIf="isStatutActif(prog.statut)" 
          class="btn-complete" 
          (click)="marquerTermine(prog)"
          title="Marquer comme termin√©">
          <i class="pi pi-check-circle"></i>
          <span>J'ai termin√© ce programme</span>
        </button>
        
        <div *ngIf="prog.statut === 'COMPLETED'" class="completed-badge">
          <i class="pi pi-check-circle"></i>
          <span>Programme termin√© ‚úì</span>
        </div>
      </div>
    </div>
  </div>
</div>
