<div class="messaging-container" [class.mobile-view]="isMobileView">
  
  <!-- Connection Status Bar -->
  <div class="connection-status" [ngClass]="'status-' + getConnectionState().toLowerCase()">
    <div class="status-indicator">
      <i 
        class="fas"
        [class.fa-circle]="isConnected()"
        [class.fa-exclamation-triangle]="!isConnected()">
      </i>
      <span>
        {{ isConnected() ? 'Connect√©' : 'D√©connect√©' }}
      </span>
    </div>
    
    <div class="queue-info" *ngIf="!isConnected() && websocketService.queueSize > 0">
      {{ websocketService.queueSize }} message(s) en attente
    </div>
  </div>

  <!-- Notification -->
  <div 
    *ngIf="notification$ | async as notification"
    class="notification"
    [ngClass]="'notification-' + notification.type"
    [class.show]="notification.show">
    <div class="notification-content">
      <i 
        class="fas"
        [class.fa-check-circle]="notification.type === 'success'"
        [class.fa-exclamation-triangle]="notification.type === 'error'"
        [class.fa-info-circle]="notification.type === 'info'">
      </i>
      <span>{{ notification.message }}</span>
    </div>
    <button class="notification-close" (click)="hideNotification()">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Main Content -->
  <div class="messaging-content">
    
    <!-- Conversation List -->
    <div 
      class="conversation-list-panel"
      [class.hidden]="isMobileView && !showConversationList">
      
      <div class="panel-header">
        <h2>Messages</h2>
        <div class="header-actions">
          <button class="btn-new-conversation-small" (click)="openContactSelection()" title="Nouvelle conversation">
            <i class="fas fa-plus"></i>
          </button>
          <div class="unread-badge" *ngIf="(unreadCount$ | async) as unreadCount">
            {{ unreadCount }}
          </div>
        </div>
      </div>
      
      <div class="conversations-container">
        <div 
          *ngFor="let conversation of (state$ | async)?.conversations; trackBy: trackByConversationId"
          class="conversation-item"
          [class.selected]="conversation.conversationId === (state$ | async)?.selectedConversationId"
          [class.unread]="conversation.messagesNonLus > 0"
          (click)="selectConversation(conversation.conversationId)"
          style="cursor: pointer; transition: all 0.2s ease; border-left: 3px solid transparent; position: relative;"
          [style.border-left-color]="conversation.conversationId === (state$ | async)?.selectedConversationId ? '#007bff' : 'transparent'"
          [title]="'Cliquez pour ouvrir la conversation avec ' + conversation.autreUtilisateurNom + (conversation.messagesNonLus > 0 ? ' (' + conversation.messagesNonLus + ' nouveaux messages)' : '')"
          [attr.aria-label]="'Conversation avec ' + conversation.autreUtilisateurNom">
          
          <div class="conversation-avatar" 
               [style.background]="conversation.autreUtilisateurRole === 'Coach' ? 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' : 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)'">
            <div class="avatar-circle">
              {{ conversation.autreUtilisateurNom.charAt(0).toUpperCase() }}
            </div>
            <div class="role-badge" 
                 [ngClass]="'role-' + conversation.autreUtilisateurRole.toLowerCase()"
                 style="position: absolute; bottom: -2px; right: -2px; background: #28a745; color: white; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 10px; border: 2px solid white;">
              {{ conversation.autreUtilisateurRole === 'Coach' ? 'üë®‚Äç‚öïÔ∏è' : 'üë§' }}
            </div>
          </div>
          
          <div class="conversation-info" style="flex: 1; min-width: 0;">
            <div class="conversation-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
              <h3 class="user-name" style="margin: 0; font-size: 14px; font-weight: 600; color: #333;">
                {{ conversation.autreUtilisateurNom }}
              </h3>
              <span class="last-message-time" style="font-size: 11px; color: #666;">
                {{ formatLastMessageTime(conversation.dateDernierMessage) }}
              </span>
            </div>
            
            <div class="last-message" style="display: flex; justify-content: space-between; align-items: center;">
              <p class="message-preview" style="margin: 0; font-size: 13px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1;">
                {{ conversation.dernierMessage }}
              </p>
              <div class="unread-count" 
                   *ngIf="conversation.messagesNonLus > 0"
                   style="background: #dc3545; color: white; border-radius: 50%; min-width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; margin-left: 8px;">
                {{ conversation.messagesNonLus }}
              </div>
            </div>
          </div>
          
          <!-- Hover effect indicator -->
          <div class="hover-indicator" 
               style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); opacity: 0; transition: opacity 0.2s ease; color: #007bff;">
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>
        
        <!-- Empty State -->
        <div *ngIf="(state$ | async)?.conversations && (state$ | async)!.conversations.length === 0" class="empty-conversations">
          <i class="fas fa-comments fa-3x"></i>
          <h3>Aucune conversation</h3>
          <p>Commencez une nouvelle conversation pour discuter avec vos contacts.</p>
          <button class="btn-new-conversation" (click)="openContactSelection()">
            <i class="fas fa-plus"></i>
            Nouvelle conversation
          </button>
        </div>
        
        <!-- Help text when conversations exist but none selected -->
        <div *ngIf="(state$ | async)?.conversations && (state$ | async)!.conversations.length > 0 && !(state$ | async)?.selectedConversationId" 
             class="conversation-help" 
             style="padding: 16px; margin: 16px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; text-align: center;">
          <i class="fas fa-hand-pointer" style="color: #856404; font-size: 24px; margin-bottom: 8px;"></i>
          <p style="margin: 0; color: #856404; font-weight: 500; font-size: 14px;">
            üëÜ Cliquez sur une conversation ci-dessus pour voir la zone de saisie de message
          </p>
        </div>
      </div>
    </div>

    <!-- Chat Window -->
    <div 
      class="chat-window-panel"
      [class.hidden]="isMobileView && showConversationList">
      
      <!-- Chat Header -->
      <div class="chat-header" *ngIf="selectedConversation$ | async as conversation">
        <button 
          class="back-button"
          *ngIf="isMobileView"
          (click)="backToConversationList()">
          <i class="fas fa-arrow-left"></i>
        </button>
        
        <div class="chat-user-info">
          <div class="chat-avatar">
            {{ conversation.autreUtilisateurNom.charAt(0).toUpperCase() }}
          </div>
          <div class="chat-user-details">
            <h3>{{ conversation.autreUtilisateurNom }}</h3>
            <span class="user-role">{{ conversation.autreUtilisateurRole }}</span>
          </div>
        </div>
        
        <div class="chat-actions">
          <button class="btn-icon" title="Informations">
            <i class="fas fa-info-circle"></i>
          </button>
        </div>
      </div>

      <!-- No Conversation Selected -->
      <div *ngIf="!(selectedConversation$ | async)" class="no-conversation-selected">
        <i class="fas fa-comments fa-4x"></i>
        <h3>S√©lectionnez une conversation</h3>
        <p>Choisissez une conversation dans la liste pour commencer √† discuter.</p>
        <div class="demo-instructions" style="margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
          <h4 style="margin: 0 0 8px 0; color: #007bff; font-size: 14px;">üí° Comment utiliser la messagerie</h4>
          <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #666;">
            <li><strong>√âtape 1:</strong> Cliquez sur une conversation √† gauche pour l'ouvrir</li>
            <li><strong>√âtape 2:</strong> La zone de saisie appara√Ætra en bas de l'√©cran</li>
            <li><strong>√âtape 3:</strong> Tapez votre message et appuyez sur Entr√©e pour l'envoyer</li>
            <li><strong>Fonctionnalit√©s:</strong> R√©ponses automatiques, indicateurs de frappe, notifications</li>
          </ul>
        </div>
      </div>

      <!-- Messages Area -->
      <div 
        *ngIf="selectedConversation$ | async"
        class="messages-area">
        
        <div class="messages-container" #messagesContainer>
          <div 
            *ngFor="let message of conversationMessages$ | async; trackBy: trackByMessageId"
            class="message-wrapper"
            [class.own-message]="message.expediteurId === currentUserId"
            [class.other-message]="message.expediteurId !== currentUserId">
            
            <app-message-bubble
              [message]="convertMessageForTemplate(message)"
              [isOwnMessage]="message.expediteurId === currentUserId">
            </app-message-bubble>
          </div>
          
          <!-- Typing Indicator -->
          <div class="typing-indicator" *ngIf="typingIndicators$ | async as indicator">
            <div class="typing-animation">
              <span></span>
              <span></span>
              <span></span>
            </div>
            <span class="typing-text">{{ indicator.username || 'Quelqu\'un' }} est en train d'√©crire...</span>
          </div>
        </div>

        <!-- Message Input -->
        <div class="message-input-area">
          <app-chat-window
            [conversationId]="(state$ | async)?.selectedConversationId ?? null"
            [disabled]="!isConnected()"
            (messageSent)="sendMessage($event.content, $event.type)"
            (typingStatusChanged)="sendTypingIndicator($event)">
          </app-chat-window>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div *ngIf="(state$ | async)?.loading" class="loading-overlay">
    <div class="spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <span>Connexion en cours...</span>
    </div>
  </div>

  <!-- Contact Selection Modal -->
  <app-contact-selection-modal
    [isVisible]="showContactSelection"
    (contactSelected)="createConversationWithContact($event)"
    (modalClosed)="closeContactSelection()">
  </app-contact-selection-modal>
</div>