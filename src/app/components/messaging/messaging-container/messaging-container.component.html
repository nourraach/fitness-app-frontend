<!-- Hero Section - Messaging -->
<div class="hero-cards-section">
  <div class="hero-card messaging-hero">
    <div class="hero-card-content">
      <div class="hero-text">
        <h1 class="hero-title">Vos conversations, <span class="text-gradient">votre univers</span></h1>
        <div class="hero-features">
          <div class="hero-feature-item">
            <span class="feature-icon">‚ú®</span>
            <span>Entrez dans un monde o√π chaque message compte</span>
          </div>
          <div class="hero-feature-item">
            <span class="feature-icon">üí¨</span>
            <span>Partagez vos id√©es en un clin d'≈ìil</span>
          </div>
          <div class="hero-feature-item">
            <span class="feature-icon">üåç</span>
            <span>Restez connect√© avec vos proches, partout et √† tout moment</span>
          </div>
        </div>
      </div>
      <div class="hero-image-wrapper">
        <div class="hero-image-glow"></div>
        <img src="assets/images/maildobmfaskha.png" alt="Messagerie" class="hero-image" />
      </div>
    </div>
  </div>
</div>

<div class="messaging-container" [class.mobile-view]="isMobileView">
  
  <!-- Main Content -->
  <div class="messaging-content">
    
    <!-- Conversation List -->
    <div 
      class="conversation-list-panel"
      [class.hidden]="isMobileView && !showConversationList">
      
      <div class="panel-header">
        <h2>üí¨ Messages</h2>
        <div class="header-actions">
          <div class="unread-badge" *ngIf="(unreadCount$ | async) as unreadCount">
            {{ unreadCount }}
          </div>
        </div>
      </div>
      
      <!-- Search Bar for Friends -->
      <div class="search-section">
        <div class="search-input-wrapper">
          <i class="fas fa-search search-icon"></i>
          <input 
            type="text" 
            [(ngModel)]="friendSearchQuery"
            (input)="onFriendSearch()"
            placeholder="Rechercher un ami..."
            class="search-input">
          <button *ngIf="friendSearchQuery" class="clear-search" (click)="clearSearch()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="conversations-container">
        <!-- Friends List (when searching or no conversations) -->
        <div *ngIf="showFriendsList || (state$ | async)?.conversations?.length === 0" class="friends-list">
          <div class="section-title">
            <i class="fas fa-user-friends"></i>
            <span>Mes Amis</span>
          </div>
          
          <div *ngIf="isLoadingFriends" class="loading-friends">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Chargement...</span>
          </div>
          
          <div 
            *ngFor="let friend of filteredFriends"
            class="friend-item"
            (click)="startConversationWithFriend(friend)">
            <div class="friend-avatar">
              {{ (friend.nom || 'U').charAt(0).toUpperCase() }}
            </div>
            <div class="friend-info">
              <div class="friend-name">{{ friend.nom || 'Utilisateur' }}</div>
              <div class="friend-email">{{ friend.email }}</div>
            </div>
            <div class="start-chat-icon">
              <i class="fas fa-comment"></i>
            </div>
          </div>
          
          <div *ngIf="!isLoadingFriends && filteredFriends.length === 0" class="no-friends">
            <i class="fas fa-user-plus"></i>
            <p *ngIf="!friendSearchQuery">Aucun ami</p>
            <p *ngIf="friendSearchQuery">Aucun ami trouv√©</p>
            <small *ngIf="!friendSearchQuery">Ajoutez des amis dans l'espace social</small>
          </div>
        </div>
        
        <!-- Conversations List -->
        <div *ngIf="!showFriendsList && (state$ | async)?.conversations?.length">
          <div class="section-title">
            <i class="fas fa-comments"></i>
            <span>Conversations</span>
            <button class="btn-show-friends" (click)="showFriendsList = true" title="Nouvelle conversation">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          
          <div 
            *ngFor="let conversation of (state$ | async)?.conversations; trackBy: trackByConversationId"
            class="conversation-item"
            [class.selected]="conversation.conversationId === (state$ | async)?.selectedConversationId"
            [class.unread]="(conversation.messagesNonLus || 0) > 0"
            (click)="selectConversation(conversation.conversationId || '')">
            
            <div class="conversation-avatar">
              {{ (conversation.autreUtilisateurNom || 'U').charAt(0).toUpperCase() }}
            </div>
            
            <div class="conversation-info">
              <div class="conversation-header">
                <span class="user-name">{{ conversation.autreUtilisateurNom || 'Utilisateur' }}</span>
                <span class="last-message-time">
                  {{ conversation.dateDernierMessage ? formatLastMessageTime(conversation.dateDernierMessage) : '' }}
                </span>
              </div>
              <div class="last-message">
                <span class="message-preview">{{ conversation.dernierMessage || '' }}</span>
                <span class="unread-count" *ngIf="(conversation.messagesNonLus || 0) > 0">
                  {{ conversation.messagesNonLus }}
                </span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Empty State -->
        <div *ngIf="!showFriendsList && (state$ | async)?.conversations?.length === 0 && filteredFriends.length === 0" class="empty-conversations">
          <i class="fas fa-comments fa-3x"></i>
          <h3>Aucune conversation</h3>
          <p>Ajoutez des amis pour commencer</p>
        </div>
      </div>
    </div>

    <!-- Chat Window -->
    <div 
      class="chat-window-panel"
      [class.hidden]="isMobileView && showConversationList">
      
      <!-- Chat Header -->
      <div class="chat-header" *ngIf="selectedConversation$ | async as conversation">
        <button 
          class="back-button"
          *ngIf="isMobileView"
          (click)="backToConversationList()">
          <i class="fas fa-arrow-left"></i>
        </button>
        
        <div class="chat-user-info">
          <div class="chat-avatar">
            {{ (conversation.autreUtilisateurNom || 'U').charAt(0).toUpperCase() }}
          </div>
          <div class="chat-user-details">
            <h3>{{ conversation.autreUtilisateurNom || 'Utilisateur' }}</h3>
            <span class="user-status">En ligne</span>
          </div>
        </div>
      </div>

      <!-- No Conversation Selected -->
      <div *ngIf="!(selectedConversation$ | async)" class="no-conversation-selected">
        <i class="fas fa-paper-plane fa-4x"></i>
        <h3>Commencez une conversation</h3>
        <p>Recherchez un ami dans la barre de recherche pour lui envoyer un message</p>
      </div>

      <!-- Messages Area -->
      <div 
        *ngIf="selectedConversation$ | async"
        class="messages-area">
        
        <div class="messages-container" #messagesContainer>
          <div 
            *ngFor="let message of conversationMessages$ | async; trackBy: trackByMessageId"
            class="message-wrapper"
            [class.own-message]="message.senderId === currentUserId"
            [class.other-message]="message.senderId !== currentUserId">
            
            <app-message-bubble
              [message]="convertMessageForTemplate(message)"
              [isOwnMessage]="message.senderId === currentUserId">
            </app-message-bubble>
          </div>
          
          <!-- Typing Indicator -->
          <div class="typing-indicator" *ngIf="typingIndicators$ | async as indicator">
            <div class="typing-animation">
              <span></span>
              <span></span>
              <span></span>
            </div>
            <span class="typing-text">√©crit...</span>
          </div>
        </div>

        <!-- Message Input -->
        <div class="message-input-area">
          <div class="message-input-wrapper">
            <input 
              type="text"
              [(ngModel)]="messageInput"
              (keydown.enter)="onSendMessage()"
              placeholder="Tapez votre message..."
              class="message-text-input">
            <button 
              class="send-button"
              (click)="onSendMessage()"
              [disabled]="!messageInput || !messageInput.trim()">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
